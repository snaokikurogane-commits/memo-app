<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ネタ帳アプリ</title>
  <style>
    /* CSSは前回と同じものをここに貼ってください */
    body { font-family: sans-serif; background-color: #f2f2f2; margin: 0; padding: 10px; color: #333; }
    /* ...中略... */
    #loading { text-align: center; margin-top: 20px; color: #666; }
  </style>
</head>
<body>
  <input type="text" id="search-box" placeholder="名前・ふりがなで検索..." onkeyup="filterList()">
  <div id="loading">読み込み中...</div>
  <ul id="person-list"></ul>

  <div id="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
    <div class="modal-content" style="background:white; width:90%; padding:20px; border-radius:10px;">
      <div id="modal-name" style="font-weight:bold; margin-bottom:10px;"></div>
      <textarea id="memo-text" style="width:100%; height:100px; margin-bottom:10px;"></textarea>
      <div id="history-area" style="background:#eee; padding:10px; height:100px; overflow-y:scroll; font-size:12px; margin-bottom:10px;"></div>
      <button onclick="closeModal()">閉じる</button>
      <button onclick="submitMemo()" style="background:#00C300; color:white; border:none; padding:10px;">送信</button>
    </div>
  </div>

  <script>
    // ★
    const API_URL = "https://script.google.com/macros/s/AKfycbzApCiru2la88of72dyGRs-2yaFwLlR-qA9NQQztY-UbZFEvIILqBfnYPtb8Rap32t7/exec";

    let allPeople = [];
    let selectedPerson = "";

    // 読み込み時
    window.onload = async function() {
      // GASからデータを取得 (fetchを使用)
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        renderList(data);
      } catch (e) {
        alert("読み込みエラー: " + e);
      }
    };

    function renderList(data) {
      allPeople = data;
      const list = document.getElementById('person-list');
      list.innerHTML = "";
      document.getElementById('loading').style.display = 'none';

      data.forEach(p => {
        const li = document.createElement('li');
        // CSSクラスなどは適宜追加してください
        li.style.background = "white"; li.style.padding = "10px"; li.style.marginBottom = "5px";
        li.dataset.searchText = (p.name + p.kana + p.section).toLowerCase();
        li.innerHTML = `<b>${p.name}</b> (${p.role})`;
        li.onclick = () => openModal(p);
        list.appendChild(li);
      });
    }

    function filterList() { /* 前回と同じロジック */ }

    async function openModal(person) {
      selectedPerson = person.name;
      document.getElementById('modal-name').innerText = person.name;
      document.getElementById('modal').style.display = 'flex';
      
      // 履歴取得
      document.getElementById('history-area').innerText = "読み込み中...";
      
      // GASに履歴を問い合わせ (POSTで送信)
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ action: "getHistory", name: person.name })
      });
      const history = await res.json();
      
      // 履歴描画（簡略化）
      let html = "";
      history.forEach(h => { html += `<div>${h.date}: ${h.memo}</div><hr>`; });
      document.getElementById('history-area').innerHTML = html;
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    async function submitMemo() {
      const memo = document.getElementById('memo-text').value;
      if(!memo) return;

      // 保存処理
      await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify({ action: "save", name: selectedPerson, memo: memo })
      });
      
      alert("保存しました");
      closeModal();
      location.reload(); // 再読み込み
    }
  </script>
</body>
</html>
