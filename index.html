<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç©¶æ¥µã®æ¥­å‹™æ”¯æ´ã‚¢ãƒ—ãƒª</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f2f2f2; margin: 0; padding: 10px; color: #333; }
    
    /* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ»é›»è»Š */
    .train-widget { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 12px; margin-bottom: 15px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .train-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .train-select { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); padding: 5px; border-radius: 15px; color: white; font-size: 12px; }
    .train-select option { color: #333; }
    .countdown-big { font-size: 32px; font-weight: bold; text-align: center; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }

    /* ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ– */
    .main-tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; white-space: nowrap; padding-bottom: 5px; }
    .main-tab-btn { flex: 1; min-width: 80px; padding: 10px 5px; background: white; border-radius: 8px; text-align: center; font-weight: bold; color: #666; cursor: pointer; font-size: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .main-tab-btn.active { background: #333; color: white; }
    
    .view-content { display: none; }
    .view-content.active { display: block; animation: fadeIn 0.3s ease; }

    /* å…±é€šã‚«ãƒ¼ãƒ‰ */
    .card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    
    /* ãƒªã‚¹ãƒˆç”»é¢ */
    #search-box { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px; box-sizing: border-box; }
    .person-card { display: flex; justify-content: space-between; align-items: center; position: relative; border-left: 5px solid transparent; }
    .person-card.pinned { border-left-color: #f4b400; }
    .p-name { font-weight: bold; font-size: 16px; }
    .p-detail { font-size: 12px; color: #666; }
    .p-tags { font-size: 10px; color: #007bff; margin-top: 2px; }
    
    /* ä»Šæ—¥ã®è©±é¡Œç”»é¢ */
    .weather-selector { text-align: center; margin-bottom: 15px; }
    .w-btn { border: 1px solid #ddd; background: white; padding: 8px 12px; border-radius: 20px; font-size: 18px; margin: 0 3px; cursor: pointer; }
    .w-btn.selected { background: #e3f2fd; border-color: #2196f3; transform: scale(1.1); }
    .gen-btn { width: 100%; padding: 12px; background: #333; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
    .topic-item { border-left: 4px solid #ddd; padding-left: 10px; margin-bottom: 10px; }
    .topic-title { font-weight: bold; color: #d32f2f; font-size: 14px; }
    .topic-content { font-size: 13px; color: #444; margin-top: 2px; }
    
    /* å­¦ã³ãƒœã‚¿ãƒ³ */
    .study-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
    .study-btn { padding: 15px; border-radius: 10px; border: none; color: white; font-weight: bold; cursor: pointer; text-align: center; font-size: 13px; }
    .btn-k { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .btn-g { background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); color: #005c4b; }
    .btn-w { grid-column: span 2; background: linear-gradient(135deg, #0f2027 0%, #203a43 100%); }

    /* ãã®ä»– */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: flex-end; z-index: 1000; }
    .modal-content { background: white; width: 100%; padding: 20px; border-radius: 15px 15px 0 0; max-height: 90vh; overflow-y: auto; box-sizing: border-box; }
    #loading { text-align: center; padding: 20px; color: #888; display: none; }
    .tag-btn { background: white; border: 1px solid #007bff; color: #007bff; padding: 4px 8px; border-radius: 15px; font-size: 11px; cursor: pointer; margin-right: 3px; margin-bottom: 3px; }
    
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>

  <div class="train-widget">
    <div class="train-header">
      <span>ğŸšƒ æ¬¡ã®é›»è»Š</span>
      <select id="route-select" class="train-select" onchange="changeRoute()">
        <option value="toWork">è¡Œãï¼šå±±è¥¿ â†’ è¡£å±±</option>
        <option value="toHome">å¸°ã‚Šï¼šè¡£å±± â†’ å±±è¥¿</option>
      </select>
    </div>
    <div id="countdown-text" class="countdown-big">--:--</div>
  </div>

  <div class="main-tabs">
    <div class="main-tab-btn active" onclick="switchMainTab('list')">ğŸ‘¥ äººç‰©</div>
    <div class="main-tab-btn" onclick="switchMainTab('daily')">â˜• è©±é¡Œ/å­¦ã³</div>
    <div class="main-tab-btn" onclick="switchMainTab('timer')">â³ çµŒé</div>
    <div class="main-tab-btn" onclick="switchMainTab('dojo')">ğŸ’ª é“å ´</div>
  </div>

  <div id="view-list" class="view-content active">
    <input type="text" id="search-box" placeholder="æ¤œç´¢..." onkeyup="filterList()">
    <div id="person-list">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>

  <div id="view-daily" class="view-content">
    <div class="card">
      <div style="text-align:center; font-weight:bold; margin-bottom:10px;">â˜€ ä»Šæ—¥ã®è©±é¡Œç”Ÿæˆ</div>
      <div class="weather-selector">
        <button class="w-btn selected" onclick="selW('â˜€ æ™´ã‚Œ',this)">â˜€</button>
        <button class="w-btn" onclick="selW('â˜ æ›‡ã‚Š',this)">â˜</button>
        <button class="w-btn" onclick="selW('â˜‚ é›¨',this)">â˜‚</button>
        <button class="w-btn" onclick="selW('â„ å¯’ã„',this)">â„</button>
      </div>
      <button class="gen-btn" onclick="genTopics()">è©±é¡Œã‚’ã¤ãã‚‹</button>
      <div id="daily-result" style="margin-top:15px;"></div>
    </div>

    <div class="study-grid">
      <button class="study-btn btn-k" onclick="genStudy('kokugo')">ğŸ‡¯ğŸ‡µ å›½èªåŠ›<br>(æ¼¢å­—ãƒ»æ•¬èª)</button>
      <button class="study-btn btn-g" onclick="genStudy('geo')">ğŸ—¾ åœ°ç†é›‘å­¦<br>(47éƒ½é“åºœçœŒ)</button>
      <button class="study-btn btn-w" onclick="genStudy('work')">ğŸ¢ ä»•äº‹ã®çŸ¥è­˜<br>(FPãƒ»ç¤¾ä¿ãƒ»åŠ´åƒæ³•)</button>
    </div>
    
    <div id="study-modal" class="modal" onclick="if(event.target===this)this.style.display='none'">
      <div class="modal-content">
        <h3 id="s-cat" style="margin-top:0;">ã‚«ãƒ†ã‚´ãƒª</h3>
        <p id="s-ques" style="font-size:18px; font-weight:bold;">å•é¡Œ</p>
        <button class="gen-btn" onclick="document.getElementById('s-ans-box').style.display='block';this.style.display='none'" id="s-show-btn">æ­£è§£ã‚’è¦‹ã‚‹</button>
        <div id="s-ans-box" style="display:none; margin-top:15px; border-top:1px dashed #ccc; padding-top:10px;">
          <div id="s-ans" style="color:#d32f2f; font-weight:bold; font-size:20px; margin-bottom:5px;">æ­£è§£</div>
          <div id="s-exp" style="font-size:14px; color:#555; background:#f9f9f9; padding:10px; border-radius:8px;">è§£èª¬</div>
        </div>
        <button style="width:100%; margin-top:15px; padding:10px; border:none; background:#eee;" onclick="document.getElementById('study-modal').style.display='none'">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <div id="view-timer" class="view-content">
    <button class="gen-btn" style="background:#007bff; margin-bottom:10px;" onclick="openTimerModal()">ï¼‹ è¨˜éŒ²è¿½åŠ </button>
    <div id="timer-list"></div>
  </div>

  <div id="view-dojo" class="view-content">
    <div class="card">
      <h3>ğŸ² è©±é¡Œã‚¬ãƒãƒ£</h3>
      <div style="display:flex; gap:5px; flex-wrap:wrap;">
        <button onclick="dojoGacha('é›‘è«‡')" style="flex:1; padding:10px;">é›‘è«‡</button>
        <button onclick="dojoGacha('ä»•äº‹')" style="flex:1; padding:10px;">ä»•äº‹</button>
        <button onclick="dojoGacha('æ„›åª›')" style="flex:1; padding:10px;">æ„›åª›</button>
      </div>
      <div id="gacha-res" style="margin-top:10px; background:#fff8e1; padding:10px; border-radius:5px; display:none;"></div>
    </div>
    <div class="card">
      <h3>ğŸ¥Š ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</h3>
      <input type="text" id="sim-in" style="width:100%; padding:10px; margin-bottom:5px;" placeholder="ä¼šè©±å…¥åŠ›...">
      <button class="gen-btn" onclick="dojoSim()">é€ä¿¡</button>
      <div id="sim-res" style="margin-top:10px; height:150px; overflow-y:auto; background:#f9f9f9; padding:5px;"></div>
    </div>
  </div>

  <div id="p-modal" class="modal" onclick="if(event.target===this)this.style.display='none'">
    <div class="modal-content">
      <h3 id="pm-name">åå‰</h3>
      <textarea id="pm-memo" style="width:100%; height:80px; padding:5px; border:1px solid #ddd;" placeholder="ãƒ¡ãƒ¢..."></textarea>
      
      <div style="display:flex; gap:2px; margin-top:5px; flex-wrap:wrap;">
        <button class="tag-btn" onclick="addTag('ã‚´ãƒ«ãƒ•')">ã‚´ãƒ«ãƒ•</button>
        <button class="tag-btn" onclick="addTag('è»Š')">ğŸš™ è»Š</button>
        <button class="tag-btn" onclick="addTag('ãƒãƒ©ã‚½ãƒ³')">ğŸƒ ãƒãƒ©ã‚½ãƒ³</button>
        <button class="tag-btn" onclick="addTag('å‹äºº')">ğŸ¤ å‹äºº</button>
        <button class="tag-btn" onclick="addTag('åœ°å…ƒ')">ğŸ  åœ°å…ƒ</button>
        <button class="tag-btn" onclick="addTag('å¤§å­¦')">ğŸ“ å¤§å­¦</button>
      </div>

      <button class="gen-btn" style="margin-top:10px;" onclick="savePerson()">ä¿å­˜</button>
      <div id="pm-hist" style="margin-top:10px; font-size:12px; color:#666;"></div>
    </div>
  </div>
  
  <div id="t-modal" class="modal" onclick="if(event.target===this)this.style.display='none'">
    <div class="modal-content">
      <h3>è¨˜éŒ²è¿½åŠ </h3>
      <input type="text" id="tm-name" placeholder="é …ç›®å(ç¾å®¹é™¢ãªã©)" style="width:100%; padding:10px; margin-bottom:5px;">
      <input type="date" id="tm-date" style="width:100%; padding:10px; margin-bottom:5px;">
      <button class="gen-btn" onclick="saveTimer()">ä¿å­˜</button>
    </div>
  </div>

  <div id="loading" class="modal" style="background:rgba(255,255,255,0.8); align-items:center; justify-content:center; color:#333; font-weight:bold;">å‡¦ç†ä¸­...</div>

  <script>
    // â˜…API_URLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
    const API_URL = "https://script.google.com/macros/s/AKfycbyRkS09x1E5TL8rHLUCnKWiKMH743XaDOWWfZ3mPBU7xhp9wzIAGKWyCU7oFGp-I94s-Q/exec";

    let allData = [];
    let curWeather = "â˜€ æ™´ã‚Œ";
    let curPerson = null;

    window.onload = async () => {
      try {
        const res = await fetch(API_URL);
        allData = await res.json();
        renderList(allData);
      } catch(e) { console.log(e); }
      loadTimer();
    };

    function switchMainTab(id) {
      document.querySelectorAll('.view-content').forEach(e => e.classList.remove('active'));
      document.querySelectorAll('.main-tab-btn').forEach(e => e.classList.remove('active'));
      document.getElementById('view-'+id).classList.add('active');
    }

    /* ä»Šæ—¥ã®è©±é¡Œ */
    function selW(w, btn) { curWeather = w; document.querySelectorAll('.w-btn').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); }
    async function genTopics() {
      showLoad(true);
      try {
        const res = await fetch(API_URL, { method:"POST", body:JSON.stringify({action:"news", weather:curWeather}) });
        const data = await res.json();
        const box = document.getElementById('daily-result');
        box.innerHTML = data.map(t => `<div class="topic-item"><div class="topic-title">${t.title}</div><div class="topic-content">${t.content}</div></div>`).join('');
      } catch(e) { alert("ã‚¨ãƒ©ãƒ¼"); }
      showLoad(false);
    }

    /* å­¦ã³ */
    async function genStudy(mode) {
      showLoad(true);
      try {
        const res = await fetch(API_URL, { method:"POST", body:JSON.stringify({action:"study", mode:mode}) });
        const data = await res.json();
        document.getElementById('s-cat').innerText = mode==='geo' ? "ğŸ“ "+data.prefecture : (data.category||"çŸ¥è­˜");
        document.getElementById('s-ques').innerText = mode==='geo' ? `ãŠåœŸç”£ã¯ï¼Ÿ\nã€Œ${data.souvenir}ã€` : data.question;
        document.getElementById('s-ans').innerText = mode==='geo' ? "ğŸ’¡ é›‘å­¦" : data.answer;
        document.getElementById('s-exp').innerText = mode==='geo' ? data.detail : data.explanation;
        document.getElementById('s-ans-box').style.display = 'none';
        document.getElementById('s-show-btn').style.display = 'block';
        document.getElementById('study-modal').style.display = 'flex';
      } catch(e) { alert("ã‚¨ãƒ©ãƒ¼"); }
      showLoad(false);
    }

    /* äººç‰©ãƒªã‚¹ãƒˆ */
    function renderList(list) {
      document.getElementById('person-list').innerHTML = list.map(p => 
        `<div class="card person-card ${p.isPinned?'pinned':''}" onclick='openPerson(${JSON.stringify(p)})'>
           <div>
             <div class="p-name">${p.name}</div>
             <div class="p-detail">${p.section} | ${p.role}</div>
             <div class="p-tags">${p.tags||""}</div>
           </div>
           ${p.eventDate ? "ğŸ””" : ""}
         </div>`
      ).join('');
    }
    function filterList() {
      const v = document.getElementById('search-box').value.toLowerCase();
      renderList(allData.filter(p => (p.name+p.tags).toLowerCase().includes(v)));
    }
    function openPerson(p) {
      curPerson = p;
      document.getElementById('pm-name').innerText = p.name;
      document.getElementById('pm-memo').value = "";
      document.getElementById('p-modal').style.display = 'flex';
    }
    async function savePerson() {
      showLoad(true);
      const memo = document.getElementById('pm-memo').value;
      if(!memo) { showLoad(false); return; }
      await fetch(API_URL, { method:"POST", body:JSON.stringify({action:"save", name:curPerson.name, memo:memo}) });
      alert("ä¿å­˜å®Œäº†");
      location.reload();
    }
    function addTag(t) { document.getElementById('pm-memo').value += " #"+t; }

    /* çµŒéç®¡ç† */
    async function loadTimer() {
      const res = await fetch(API_URL + "?action=getTimer");
      const data = await res.json();
      const grouped = {};
      data.forEach(t => { if(!grouped[t.name]) grouped[t.name]=t; });
      document.getElementById('timer-list').innerHTML = Object.values(grouped).map(t => {
        const diff = Math.floor((new Date() - new Date(t.date))/(86400000));
        return `<div class="card"><div>${t.name}</div><div style="font-size:20px; font-weight:bold;">${diff}æ—¥å‰</div></div>`;
      }).join('');
    }
    function openTimerModal() { document.getElementById('t-modal').style.display = 'flex'; }
    async function saveTimer() {
      showLoad(true);
      const name = document.getElementById('tm-name').value;
      const date = document.getElementById('tm-date').value;
      await fetch(API_URL, { method:"POST", body:JSON.stringify({action:"saveTimer", eventName:name, date:date}) });
      alert("å®Œäº†");
      location.reload();
    }

    /* é“å ´ */
    async function dojoGacha(topic) {
      showLoad(true);
      const res = await fetch(API_URL, { method:"POST", body:JSON.stringify({action:"training", mode:"gacha", text:topic}) });
      const d = await res.json();
      document.getElementById('gacha-res').style.display = 'block';
      document.getElementById('gacha-res').innerHTML = `<b>${d.topic}</b><br>${d.detail}`;
      showLoad(false);
    }
    async function dojoSim() {
      const txt = document.getElementById('sim-in').value;
      if(!txt) return;
      document.getElementById('sim-res').innerHTML += `<div>è‡ªåˆ†: ${txt}</div>`;
      document.getElementById('sim-in').value = "";
      const res = await fetch(API_URL, { method:"POST", body:JSON.stringify({action:"training", mode:"sim", text:txt}) });
      const d = await res.json();
      document.getElementById('sim-res').innerHTML += `<div style="color:blue;">AI: ${d.reply}</div><div style="font-size:10px; color:red;">${d.score}ç‚¹: ${d.advice}</div>`;
    }

    function showLoad(b) { document.getElementById('loading').style.display = b ? 'flex' : 'none'; }
    
    // é›»è»Šã‚¿ã‚¤ãƒãƒ¼ (ç°¡æ˜“ç‰ˆ)
    setInterval(() => {
      const now = new Date();
      const mins = [6, 21, 36, 51];
      let next = null;
      for(let m of mins) {
        if(now.getMinutes() < m) { next = new Date(now); next.setMinutes(m); next.setSeconds(0); break; }
      }
      if(!next) { next = new Date(now); next.setHours(now.getHours()+1); next.setMinutes(mins[0]); next.setSeconds(0); }
      const diff = Math.floor((next - now)/1000);
      document.getElementById('countdown-text').innerText = `${Math.floor(diff/60)}åˆ†${diff%60}ç§’`;
    }, 1000);
  </script>
</body>
</html>
