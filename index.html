<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ¥­å‹™æ”¯æ´ã‚·ãƒ³ãƒ—ãƒ«</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f2f2f2; margin: 0; padding: 10px; color: #333; }
    
    /* é›»è»Šã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ */
    .train-widget { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 12px; margin-bottom: 15px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .train-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .train-select { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); padding: 5px; border-radius: 15px; color: white; font-size: 12px; }
    .train-select option { color: #333; }
    .countdown-big { font-size: 32px; font-weight: bold; text-align: center; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }

    /* ã‚¿ãƒ– */
    .main-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
    .main-tab-btn { flex: 1; padding: 12px; background: white; border-radius: 8px; text-align: center; font-weight: bold; color: #666; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
    .main-tab-btn.active { background: #333; color: white; }
    
    .view-content { display: none; }
    .view-content.active { display: block; animation: fadeIn 0.3s ease; }

    /* å…±é€šã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
    .card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); cursor: pointer; }
    
    /* ãƒªã‚¹ãƒˆç”»é¢ */
    #search-box { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 15px; box-sizing: border-box; font-size: 16px; }
    .person-card { display: flex; justify-content: space-between; align-items: center; position: relative; border-left: 5px solid transparent; }
    .person-card.pinned { border-left-color: #f4b400; }
    .p-name { font-weight: bold; font-size: 17px; }
    .p-detail { font-size: 12px; color: #666; margin-top: 2px; }
    .p-tags { font-size: 11px; color: #007bff; margin-top: 4px; }
    .bell { color: #f4b400; font-size: 14px; margin-left: 5px; }

    /* ã‚¿ã‚¤ãƒãƒ¼ç”»é¢ */
    .timer-add-btn { width: 100%; padding: 15px; background: #007bff; color: white; border: none; border-radius: 8px; font-weight: bold; margin-bottom: 15px; cursor: pointer; }
    .timer-date { font-size: 12px; color: #999; }
    .timer-diff { font-size: 20px; font-weight: bold; color: #333; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: flex-end; justify-content: center; z-index: 1000; }
    .modal-content { background: white; width: 100%; max-width: 600px; padding: 20px; border-radius: 15px 15px 0 0; max-height: 90vh; overflow-y: auto; box-sizing: border-box; display: flex; flex-direction: column; }
    
    /* è©³ç´°ç”»é¢ã®è¦ç´  */
    .m-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .m-name { font-size: 20px; font-weight: bold; }
    
    textarea { width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; resize: none; background: #fafafa; box-sizing: border-box; margin-bottom: 10px; }
    
    /* ã‚¿ã‚°ãƒœã‚¿ãƒ³ */
    .tag-area { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 15px; }
    .tag-btn { background: white; border: 1px solid #007bff; color: #007bff; padding: 5px 10px; border-radius: 15px; font-size: 12px; cursor: pointer; }
    
    /* å¾©æ´»ã•ã›ãŸã‚¤ãƒ™ãƒ³ãƒˆå…¥åŠ›æ¬„ */
    .event-box { background: #f0f8ff; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #d0e0ff; }
    .event-label { font-size: 12px; font-weight: bold; color: #007bff; margin-bottom: 5px; }
    .input-row { display: flex; gap: 10px; }
    .input-date { flex: 1; padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; }
    .input-text { flex: 2; padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; }

    /* å¾©æ´»ã•ã›ãŸå±¥æ­´ã‚¨ãƒªã‚¢ */
    .history-box { background: #f9f9f9; padding: 10px; border-radius: 8px; border: 1px solid #eee; max-height: 200px; overflow-y: auto; margin-top: 10px; }
    .h-item { border-bottom: 1px solid #eee; padding: 8px 0; font-size: 13px; }
    .h-date { color: #00b900; font-weight: bold; font-size: 11px; margin-bottom: 2px; }
    .h-ai { background: #fff5f5; color: #666; font-size: 11px; padding: 5px; margin-top: 5px; border-radius: 4px; }

    .btn-group { display: flex; gap: 10px; margin-top: 15px; }
    button.action-btn { padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; flex: 1; }
    .btn-save { background: #333; color: white; }
    .btn-close { background: #eee; color: #555; }
    
    #loading { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); align-items:center; justify-content:center; font-weight:bold; color:#333; z-index:2000; }
    
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  </style>
</head>
<body>

  <div class="train-widget">
    <div class="train-header">
      <span>ğŸšƒ æ¬¡ã®é›»è»Š</span>
      <select id="route-select" class="train-select" onchange="changeRoute()">
        <option value="toWork">è¡Œãï¼šå±±è¥¿ â†’ è¡£å±±</option>
        <option value="toHome">å¸°ã‚Šï¼šè¡£å±± â†’ å±±è¥¿</option>
      </select>
    </div>
    <div id="countdown-text" class="countdown-big">--:--</div>
  </div>

  <div class="main-tabs">
    <div class="main-tab-btn active" onclick="switchMainTab('list')">ğŸ‘¥ äººç‰©ãƒªã‚¹ãƒˆ</div>
    <div class="main-tab-btn" onclick="switchMainTab('timer')">â³ çµŒéç®¡ç†</div>
  </div>

  <div id="view-list" class="view-content active">
    <input type="text" id="search-box" placeholder="åå‰ãƒ»ã‚¿ã‚°ã§æ¤œç´¢..." onkeyup="filterList()">
    <div id="person-list">èª­ã¿è¾¼ã¿ä¸­...</div>
  </div>

  <div id="view-timer" class="view-content">
    <button class="timer-add-btn" onclick="openTimerModal()">ï¼‹ è¨˜éŒ²è¿½åŠ </button>
    <div id="timer-list"></div>
  </div>

  <div id="p-modal" class="modal" onclick="if(event.target===this)closePerson()">
    <div class="modal-content">
      <div class="m-header">
        <div class="m-name" id="pm-name">åå‰</div>
        <div style="font-size:12px; color:#666;" id="pm-detail">è©³ç´°</div>
      </div>
      
      <textarea id="pm-memo" placeholder="æ–°ã—ã„ãƒ¡ãƒ¢ã‚’å…¥åŠ›..."></textarea>
      
      <div class="tag-area">
        <button class="tag-btn" onclick="addTag('ã‚´ãƒ«ãƒ•')">ã‚´ãƒ«ãƒ•</button>
        <button class="tag-btn" onclick="addTag('è»Š')">ğŸš™ è»Š</button>
        <button class="tag-btn" onclick="addTag('ãƒãƒ©ã‚½ãƒ³')">ğŸƒ ãƒãƒ©ã‚½ãƒ³</button>
        <button class="tag-btn" onclick="addTag('å‹äºº')">ğŸ¤ å‹äºº</button>
        <button class="tag-btn" onclick="addTag('åœ°å…ƒ')">ğŸ  åœ°å…ƒ</button>
        <button class="tag-btn" onclick="addTag('å¤§å­¦')">ğŸ“ å¤§å­¦</button>
      </div>

      <div class="event-box">
        <div class="event-label">ğŸ“… èª•ç”Ÿæ—¥ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š</div>
        <div class="input-row">
          <input type="date" id="pm-date" class="input-date">
          <input type="text" id="pm-event" class="input-text" placeholder="ä¾‹: èª•ç”Ÿæ—¥">
        </div>
      </div>

      <div style="font-size:12px; font-weight:bold; color:#555;">â–¼ éå»ã®ãƒ¡ãƒ¢å±¥æ­´</div>
      <div id="pm-history" class="history-box">èª­ã¿è¾¼ã¿ä¸­...</div>

      <div class="btn-group">
        <button class="action-btn btn-close" onclick="closePerson()">é–‰ã˜ã‚‹</button>
        <button class="action-btn btn-save" onclick="savePerson()">ä¿å­˜</button>
      </div>
    </div>
  </div>
  
  <div id="t-modal" class="modal" onclick="if(event.target===this)this.style.display='none'">
    <div class="modal-content">
      <h3>è¨˜éŒ²è¿½åŠ </h3>
      <input type="text" id="tm-name" class="input-text" placeholder="é …ç›®å(ç¾å®¹é™¢ãªã©)" style="width:100%; margin-bottom:10px;">
      <input type="date" id="tm-date" class="input-date" style="width:100%; margin-bottom:10px;">
      <textarea id="tm-memo" placeholder="ãƒ¡ãƒ¢" style="height:60px;"></textarea>
      <div class="btn-group">
        <button class="action-btn btn-close" onclick="document.getElementById('t-modal').style.display='none'">é–‰ã˜ã‚‹</button>
        <button class="action-btn btn-save" onclick="saveTimer()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <div id="loading">å‡¦ç†ä¸­...</div>

  <script>
    // â˜…ã“ã“ã«æ–°ã—ã„GASã®URLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
    const API_URL = "https://script.google.com/macros/s/AKfycbzFszUa3gFBGOZeKynvNkwZzjUcVgnDZTrADu_HNkcLxp3oTPu4bUbby4WXEQ0Jh9TkRQ/exec";

    /* é›»è»Šãƒ‡ãƒ¼ã‚¿ */
    const TIMETABLE = { toWork: { startHour: 6, endHour: 23, minutes: [6, 21, 36, 51] }, toHome: { startHour: 6, endHour: 23, minutes: [7, 22, 37, 52] } };
    let allData = [];
    let curPerson = null;

    window.onload = async () => {
      try {
        const res = await fetch(API_URL);
        allData = await res.json();
        renderList(allData);
      } catch(e) { console.log(e); }
      loadTimer();
    };

    function switchMainTab(id) {
      document.querySelectorAll('.view-content').forEach(e => e.classList.remove('active'));
      document.querySelectorAll('.main-tab-btn').forEach(e => e.classList.remove('active'));
      document.getElementById('view-'+id).classList.add('active');
      // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åˆ‡ã‚Šæ›¿ãˆ
      const btns = document.querySelectorAll('.main-tab-btn');
      if(id === 'list') btns[0].classList.add('active'); else btns[1].classList.add('active');
    }

    /* äººç‰©ãƒªã‚¹ãƒˆ */
    function renderList(list) {
      const box = document.getElementById('person-list');
      if(list.length === 0) { box.innerHTML = "ãƒ‡ãƒ¼ã‚¿ãªã—"; return; }
      box.innerHTML = list.map(p => 
        `<div class="card person-card ${p.isPinned?'pinned':''}" onclick='openPerson(${JSON.stringify(p)})'>
           <div>
             <div class="p-name">${p.name} <span class="bell">${p.eventDate ? "ğŸ””" : ""}</span></div>
             <div class="p-detail">${p.section} | ${p.role}</div>
             <div class="p-tags">${p.tags||""}</div>
           </div>
         </div>`
      ).join('');
    }

    function filterList() {
      const v = document.getElementById('search-box').value.toLowerCase();
      renderList(allData.filter(p => (p.name+p.tags).toLowerCase().includes(v)));
    }

    /* è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå±¥æ­´èª­ã¿è¾¼ã¿ä»˜ãï¼‰ */
    async function openPerson(p) {
      curPerson = p;
      document.getElementById('pm-name').innerText = p.name;
      document.getElementById('pm-detail').innerText = `${p.section} / ${p.role}`;
      document.getElementById('pm-memo').value = "";
      
      // ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‚’ã‚»ãƒƒãƒˆ
      document.getElementById('pm-date').value = p.eventDate || "";
      document.getElementById('pm-event').value = p.eventName || "";

      document.getElementById('p-modal').style.display = 'flex';
      
      // â˜…å±¥æ­´ã‚’å–å¾—ã—ã¦è¡¨ç¤º
      const histBox = document.getElementById('pm-history');
      histBox.innerHTML = "èª­ã¿è¾¼ã¿ä¸­...";
      try {
        const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getHistory", name: p.name }) });
        const history = await res.json();
        if(history.length === 0) {
          histBox.innerHTML = "å±¥æ­´ãªã—";
        } else {
          histBox.innerHTML = history.map(h => 
            `<div class="h-item">
               <div class="h-date">${h.date}</div>
               <div>${h.memo}</div>
               ${h.aiAdvice ? `<div class="h-ai">ğŸ’¡ ${h.aiAdvice}</div>` : ""}
             </div>`
          ).join('');
        }
      } catch(e) {
        histBox.innerHTML = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
      }
    }

    function closePerson() { document.getElementById('p-modal').style.display = 'none'; }
    function addTag(t) { document.getElementById('pm-memo').value += " #"+t; }

    async function savePerson() {
      showLoad(true);
      const memo = document.getElementById('pm-memo').value;
      const eDate = document.getElementById('pm-date').value;
      const eName = document.getElementById('pm-event').value;
      
      // ãƒ¡ãƒ¢ã‹ã‚‰ã‚¿ã‚°æŠ½å‡º
      let tags = "";
      if (memo.includes("#")) {
        tags = memo.match(/#[^\s]+/g).join(" ");
      } else {
        tags = curPerson.tags || ""; // æ–°ã—ã„ã‚¿ã‚°ãŒãªã‘ã‚Œã°æ—¢å­˜ã‚’ç¶­æŒ
      }

      await fetch(API_URL, { 
        method:"POST", 
        body:JSON.stringify({
          action: "save", 
          name: curPerson.name, 
          memo: memo,
          eventDate: eDate,
          eventName: eName,
          tags: tags // ã‚¿ã‚°ã‚‚æ›´æ–°
        }) 
      });
      alert("ä¿å­˜ã—ã¾ã—ãŸ");
      location.reload();
    }

    /* çµŒéç®¡ç† */
    async function loadTimer() {
      const res = await fetch(API_URL + "?action=getTimer");
      const data = await res.json();
      const grouped = {};
      data.forEach(t => { if(!grouped[t.name]) grouped[t.name]=t; });
      document.getElementById('timer-list').innerHTML = Object.values(grouped).map(t => {
        const diff = Math.floor((new Date() - new Date(t.date))/(86400000));
        return `<div class="card">
                  <div>${t.name}</div>
                  <div class="timer-date">æœ€çµ‚: ${t.date}</div>
                  <div class="timer-diff">${diff}æ—¥å‰</div>
                  <div style="font-size:12px; color:#666;">${t.memo||""}</div>
                </div>`;
      }).join('');
    }
    function openTimerModal() { document.getElementById('t-modal').style.display = 'flex'; }
    async function saveTimer() {
      showLoad(true);
      const name = document.getElementById('tm-name').value;
      const date = document.getElementById('tm-date').value;
      const memo = document.getElementById('tm-memo').value;
      await fetch(API_URL, { method:"POST", body:JSON.stringify({action:"saveTimer", eventName:name, date:date, memo:memo}) });
      alert("å®Œäº†");
      location.reload();
    }

    /* ãã®ä»– */
    function changeRoute() { localStorage.setItem("trainRoute", document.getElementById("route-select").value); }
    function showLoad(b) { document.getElementById('loading').style.display = b ? 'flex' : 'none'; }
    
    // é›»è»Šã‚¿ã‚¤ãƒãƒ¼
    setInterval(() => {
      const now = new Date();
      const mins = [6, 21, 36, 51];
      let next = null;
      for(let m of mins) {
        if(now.getMinutes() < m) { next = new Date(now); next.setMinutes(m); next.setSeconds(0); break; }
      }
      if(!next) { next = new Date(now); next.setHours(now.getHours()+1); next.setMinutes(mins[0]); next.setSeconds(0); }
      const diff = Math.floor((next - now)/1000);
      document.getElementById('countdown-text').innerText = `${Math.floor(diff/60)}åˆ†${('0'+diff%60).slice(-2)}ç§’`;
    }, 1000);
  </script>
</body>
</html>
