<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒã‚¿å¸³ã‚¢ãƒ—ãƒª</title>
  <style>
    /* ãƒ™ãƒ¼ã‚¹CSSï¼ˆå‰å›ã¨åŒã˜ï¼‰ */
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f2f2f2; margin: 0; padding: 10px; color: #333; }
    #search-box { width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; margin-bottom: 15px; background: white; appearance: none; }
    #person-list { list-style: none; padding: 0; margin: 0; padding-bottom: 60px; }
    .person-card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.1); cursor: pointer; }
    .p-name { font-size: 17px; font-weight: bold; }
    .p-kana { font-size: 11px; color: #999; margin-left: 8px; }
    .p-detail { font-size: 12px; color: #666; margin-top: 2px; }
    .p-role { color: #00b900; font-weight: bold; }
    .icon-edit { font-size: 18px; color: #ccc; }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: flex-end; justify-content: center; z-index: 1000; }
    .modal-content { background: white; width: 100%; max-width: 600px; padding: 20px; border-radius: 16px 16px 0 0; box-sizing: border-box; display: flex; flex-direction: column; max-height: 95vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .m-name { font-size: 18px; font-weight: bold; }
    
    textarea { width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 15px; resize: none; background: #fafafa; }
    
    .event-section { background: #f0f8ff; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #d0e0ff; }
    .input-row { display: flex; gap: 10px; }
    .input-date { flex: 1; padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; }
    .input-text { flex: 2; padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; }

    /* â˜…AIå±¥æ­´ã‚¨ãƒªã‚¢ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
    #history-area { background: #f9f9f9; padding: 10px; border-radius: 8px; overflow-y: auto; font-size: 13px; margin-bottom: 15px; border: 1px solid #eee; min-height: 80px; max-height: 250px; }
    .history-item { border-bottom: 1px solid #ddd; padding: 10px 0; }
    .history-date { color: #00b900; font-weight: bold; font-size: 11px; margin-bottom: 4px; }
    .history-text { font-size: 14px; color: #333; margin-bottom: 8px; }
    
    /* AIã‚¢ãƒ‰ãƒã‚¤ã‚¹ã®ç®± */
    .ai-box { background: #fff5f5; border-left: 4px solid #ff6b6b; padding: 8px; border-radius: 4px; font-size: 12px; color: #555; margin-top: 5px; }
    .ai-title { font-weight: bold; color: #d63333; margin-bottom: 4px; display: flex; align-items: center; }

    .btn-group { display: flex; gap: 10px; }
    button { padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; flex: 1; }
    .btn-cancel { background: #eee; color: #555; }
    .btn-submit { background: #00b900; color: white; }
    #loading { text-align: center; margin-top: 50px; color: #666; }
  </style>
</head>
<body>

  <input type="text" id="search-box" placeholder="åå‰ãƒ»ãµã‚ŠãŒãªã§æ¤œç´¢..." onkeyup="filterList()">
  <div id="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
  <ul id="person-list"></ul>

  <div id="modal" onclick="if(event.target === this) closeModal()">
    <div class="modal-content">
      <div class="modal-header">
        <div><div id="modal-name" class="m-name"></div><div id="modal-detail" style="font-size:12px; color:#666;"></div></div>
      </div>
      
      <textarea id="memo-text" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›..."></textarea>
      
      <div class="event-section">
        <label style="font-size:12px; font-weight:bold; color:#0056b3;">ğŸ”” ã‚¤ãƒ™ãƒ³ãƒˆé€šçŸ¥</label>
        <div class="input-row">
          <input type="date" id="event-date" class="input-date">
          <input type="text" id="event-name" class="input-text" placeholder="ä¾‹: èª•ç”Ÿæ—¥">
        </div>
      </div>

      <div style="font-size:12px; font-weight:bold; color:#555; margin-bottom:5px;">â–¼ éå»ã®ãƒ¡ãƒ¢ï¼†AIææ¡ˆ</div>
      <div id="history-area">èª­ã¿è¾¼ã¿ä¸­...</div>
      
      <div class="btn-group">
        <button class="btn-cancel" onclick="closeModal()">é–‰ã˜ã‚‹</button>
        <button class="btn-submit" onclick="submitMemo()">é€ä¿¡</button>
      </div>
    </div>
  </div>

  <script>
    // â˜…GASã®URLã‚’ã‚»ãƒƒãƒˆ
    const API_URL = "https://script.google.com/macros/s/AKfycbyDU51p06sfivYJ05DCj60CBoJi8J62kLuagR88fVXviopESvT3_uqERuNZyE3wohD1tA/exec";

    let allPeople = [];
    let selectedPerson = "";

    window.onload = async function() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        renderList(data);
      } catch (e) { document.getElementById('loading').innerText = "Load Error"; }
    };

    function renderList(data) {
      allPeople = data;
      const list = document.getElementById('person-list');
      list.innerHTML = "";
      document.getElementById('loading').style.display = 'none';

      data.forEach(p => {
        const li = document.createElement('li');
        li.className = 'person-card';
        li.dataset.searchText = (p.name + p.kana + p.section + p.role).toLowerCase();
        const bell = p.eventDate ? "ğŸ””" : "";
        li.innerHTML = `
          <div class="p-info">
            <div class="p-name">${p.name} ${bell} <span class="p-kana">${p.kana}</span></div>
            <div class="p-detail"><span class="p-role">${p.role}</span> | ${p.section}</div>
          </div>
          <div class="icon-edit">âœ</div>
        `;
        li.onclick = () => openModal(p);
        list.appendChild(li);
      });
    }

    function filterList() {
      const term = document.getElementById('search-box').value.toLowerCase();
      document.querySelectorAll('.person-card').forEach(item => {
        item.style.display = item.dataset.searchText.includes(term) ? 'flex' : 'none';
      });
    }

    async function openModal(person) {
      selectedPerson = person.name;
      document.getElementById('modal-name').innerText = person.name;
      document.getElementById('modal-detail').innerText = `${person.section} / ${person.role}`;
      document.getElementById('memo-text').value = "";
      document.getElementById('event-date').value = person.eventDate || "";
      document.getElementById('event-name').value = person.eventName || "";
      document.getElementById('modal').style.display = 'flex';
      
      const historyArea = document.getElementById('history-area');
      historyArea.innerHTML = '<div style="color:#999;">èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      try {
        const res = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify({ action: "getHistory", name: person.name })
        });
        const history = await res.json();
        
        if (!history || history.length === 0) {
          historyArea.innerHTML = '<div style="color:#ccc;">å±¥æ­´ãªã—</div>';
        } else {
          let html = "";
          history.forEach(h => {
            // â˜…AIææ¡ˆãŒã‚ã‚Œã°è¡¨ç¤ºã™ã‚‹
            let aiHtml = "";
            if (h.aiAdvice) {
              aiHtml = `
                <div class="ai-box">
                  <div class="ai-title">ğŸ¤– AIã‹ã‚‰ã®è©±é¡Œææ¡ˆ</div>
                  ${h.aiAdvice.replace(/\n/g, '<br>')}
                </div>
              `;
            }

            html += `
              <div class="history-item">
                <div class="history-date">${h.date}</div>
                <div class="history-text">${h.memo}</div>
                ${aiHtml}
              </div>`;
          });
          historyArea.innerHTML = html;
        }
      } catch (e) { historyArea.innerText = "Error"; }
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }

    async function submitMemo() {
      const memo = document.getElementById('memo-text').value;
      const eventDate = document.getElementById('event-date').value;
      const eventName = document.getElementById('event-name').value;
      
      if (!memo && !eventDate) return;

      const btn = document.querySelector('.btn-submit');
      btn.innerText = "AIæ€è€ƒä¸­..."; // â˜…AIãŒè€ƒãˆã‚‹ã®ã§å°‘ã—æ™‚é–“ãŒã‹ã‹ã‚‹ã“ã¨ã‚’è¡¨ç¤º
      btn.disabled = true;

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify({ 
            action: "save", 
            name: selectedPerson, 
            memo: memo,
            eventDate: eventDate,
            eventName: eventName
          })
        });
        const result = await res.json();
        
        if (result.status === "success") {
          alert("ä¿å­˜ã—ã¾ã—ãŸï¼\nAIãŒæ¬¡å›ã®è©±é¡Œã‚’è€ƒãˆã¾ã—ãŸã€‚å±¥æ­´ã‚’ç¢ºèªã—ã¦ã¿ã¦ãã ã•ã„ã€‚");
          closeModal();
          location.reload(); 
        } else {
          alert("å¤±æ•—: " + result.message);
        }
      } catch (e) { alert("Error: " + e); } 
      finally {
        btn.innerText = "é€ä¿¡";
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
