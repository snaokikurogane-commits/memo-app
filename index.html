<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç©¶æ¥µã®ãƒã‚¿å¸³</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f2f2f2; margin: 0; padding: 10px; color: #333; }
    
    /* ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆé¡ */
    .train-widget { background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 99%); padding: 15px; border-radius: 12px; margin-bottom: 20px; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .train-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .train-select { background: rgba(255,255,255,0.9); border: none; padding: 5px 10px; border-radius: 20px; font-weight: bold; color: #333; font-size: 14px; }
    .train-timer { text-align: center; }
    .countdown-big { font-size: 36px; font-weight: bold; line-height: 1.2; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
    .next-time-sub { font-size: 14px; font-weight: bold; margin-top: 5px; }

    /* ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ– */
    .main-tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; }
    .main-tab-btn { flex: 1; min-width: 90px; padding: 10px 5px; background: white; border-radius: 8px; text-align: center; font-weight: bold; color: #666; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.1); font-size: 13px; }
    .main-tab-btn.active { background: #333; color: white; }
    .view-content { display: none; }
    .view-content.active { display: block; }

    /* ãƒªã‚¹ãƒˆæ±ç”¨ */
    #search-box { width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; margin-bottom: 15px; background: white; appearance: none; }
    #person-list, #timer-list { list-style: none; padding: 0; margin: 0; padding-bottom: 60px; }
    .person-card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.1); cursor: pointer; border-left: 5px solid transparent; position: relative; }
    .status-warning { border-left-color: #ffc107; background-color: #fffdf5; }
    .status-danger { border-left-color: #ff4d4d; background-color: #fff5f5; }
    .pin-icon { position: absolute; top: 10px; right: 40px; font-size: 18px; color: #ccc; z-index: 10; }
    .pin-icon.active { color: #f4b400; text-shadow: 0 0 2px orange; }
    .p-info { flex: 1; }
    .p-name { font-size: 17px; font-weight: bold; }
    .p-kana { font-size: 11px; color: #999; margin-left: 8px; }
    .p-detail { font-size: 12px; color: #666; margin-top: 2px; }
    .p-personality { font-size: 10px; background: #e0f7fa; color: #006064; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 2px; margin-right: 4px; }
    .p-tags { font-size: 11px; color: #007bff; margin-top: 2px; }
    .icon-edit { font-size: 18px; color: #ccc; }

    /* SinceTimer */
    .timer-card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); cursor: pointer; }
    .t-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .t-name { font-size: 16px; font-weight: bold; color: #333; }
    .t-date { font-size: 12px; color: #888; }
    .t-body { display: flex; align-items: baseline; gap: 5px; }
    .t-days { font-size: 28px; font-weight: bold; color: #333; }
    .t-unit { font-size: 12px; color: #666; }
    .t-past { color: #d32f2f; }
    .t-future { color: #00b900; }
    .timer-add-btn { width: 100%; padding: 15px; background: #007bff; color: white; border: none; border-radius: 8px; font-weight: bold; margin-bottom: 15px; cursor: pointer; font-size: 16px; }

    /* ä¼šè©±é“å ´ */
    .dojo-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .dojo-title { font-weight: bold; margin-bottom: 10px; color: #d32f2f; }
    .gacha-btns { display: flex; flex-wrap: wrap; gap: 8px; }
    .gacha-btn { flex: 1; min-width: 80px; padding: 10px; border: 1px solid #ddd; background: #fafafa; border-radius: 8px; cursor: pointer; font-size: 13px; text-align: center; }
    .gacha-result { margin-top: 15px; background: #fff8e1; padding: 15px; border-radius: 8px; display: none; border: 2px dashed #ffecb3; }
    .gr-topic { font-weight: bold; font-size: 16px; margin-bottom: 5px; color: #f57f17; }
    .chat-box { height: 200px; overflow-y: auto; background: #f9f9f9; border: 1px solid #eee; border-radius: 8px; padding: 10px; margin-bottom: 10px; }
    .chat-msg { margin-bottom: 10px; padding: 8px 12px; border-radius: 12px; font-size: 13px; max-width: 80%; }
    .msg-user { background: #dcedc8; margin-left: auto; text-align: right; color: #33691e; }
    .msg-ai { background: white; margin-right: auto; border: 1px solid #ddd; }
    .msg-feedback { font-size: 11px; color: #d32f2f; margin-top: 2px; display: block; background: #ffebee; padding: 4px; border-radius: 4px; }
    .sim-input-area { display: flex; gap: 5px; }
    .sim-input { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ddd; }
    .sim-btn { padding: 10px 15px; background: #d32f2f; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: flex-end; justify-content: center; z-index: 1000; }
    .modal-content { background: white; width: 100%; max-width: 600px; padding: 20px; border-radius: 16px 16px 0 0; box-sizing: border-box; display: flex; flex-direction: column; max-height: 95vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .m-name { font-size: 18px; font-weight: bold; }
    .tab-group { display: flex; margin-bottom: 10px; border-bottom: 1px solid #ddd; }
    .tab-btn { flex: 1; padding: 10px; text-align: center; cursor: pointer; color: #666; border-bottom: 3px solid transparent; font-weight: bold; }
    .tab-btn.active { color: #00b900; border-bottom-color: #00b900; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .memo-area-wrapper { position: relative; margin-bottom: 15px; }
    textarea { width: 100%; height: 80px; padding: 10px; padding-right: 40px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; resize: none; background: #fafafa; box-sizing: border-box;}
    .mic-btn { position: absolute; right: 10px; bottom: 10px; width: 30px; height: 30px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; border: none; }
    .mic-btn.recording { background: #ff4d4d; color: white; animation: pulse 1s infinite; }
    .input-row { display: flex; gap: 10px; margin-bottom: 5px;}
    .input-date { flex: 1; padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; }
    .input-text { flex: 2; padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; }
    .btn-group { display: flex; gap: 10px; margin-top: 15px; }
    button { padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; flex: 1; }
    .btn-cancel { background: #eee; color: #555; }
    .btn-submit { background: #00b900; color: white; }
    #loading { text-align: center; margin-top: 50px; color: #666; }
    .gift-form { background: #fff8e1; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #ffecb3; }
    .gift-type-select { padding: 8px; border-radius: 5px; border: 1px solid #ccc; background: white; margin-right: 5px; }
    .gift-add-btn { background: #ffa000; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
    #gift-list { list-style: none; padding: 0; max-height: 200px; overflow-y: auto; }
    .gift-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #ccc; font-size: 13px; }
    .gift-give { color: #d32f2f; font-weight: bold; } .gift-receive { color: #388e3c; font-weight: bold; }
    #history-area { background: #f9f9f9; padding: 10px; border-radius: 8px; overflow-y: auto; font-size: 13px; margin-bottom: 15px; border: 1px solid #eee; min-height: 80px; max-height: 250px; }
    .history-item { border-bottom: 1px solid #ddd; padding: 10px 0; }
    .history-date { color: #00b900; font-weight: bold; font-size: 11px; margin-bottom: 4px; }
    
    /* ã‚¿ã‚°ãƒœã‚¿ãƒ³ */
    .tag-buttons { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
    .tag-btn { background: white; border: 1px solid #007bff; color: #007bff; padding: 4px 10px; border-radius: 20px; font-size: 12px; cursor: pointer; }
    .ai-box { background: #fff5f5; border-left: 4px solid #ff6b6b; padding: 8px; border-radius: 4px; font-size: 12px; color: #555; margin-top: 5px; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
  </style>
</head>
<body>

  <div class="train-widget">
    <div class="train-header">
      <span style="font-weight:bold;">ğŸšƒ æ¬¡ã®é›»è»Š</span>
      <select id="route-select" class="train-select" onchange="changeRoute()">
        <option value="toWork">è¡Œãï¼šå±±è¥¿ â†’ è¡£å±±</option>
        <option value="toHome">å¸°ã‚Šï¼šè¡£å±± â†’ å±±è¥¿</option>
      </select>
    </div>
    <div class="train-timer">
      <div id="countdown-text" class="countdown-big">-- åˆ† -- ç§’</div>
      <div id="next-time-text" class="next-time-sub">ç™ºè»Šæ™‚åˆ»: --:--</div>
    </div>
  </div>

  <div class="main-tabs">
    <div class="main-tab-btn active" onclick="switchMainTab('list')">ğŸ‘¥ äººç‰©ãƒªã‚¹ãƒˆ</div>
    <div class="main-tab-btn" onclick="switchMainTab('timer')">â³ çµŒéç®¡ç†</div>
    <div class="main-tab-btn" onclick="switchMainTab('dojo')">ğŸ’ª ä¼šè©±é“å ´</div>
  </div>

  <div id="view-list" class="view-content active">
    <input type="text" id="search-box" placeholder="åå‰ãƒ»ã‚¿ã‚°ãƒ»æ€§æ ¼ã§æ¤œç´¢..." onkeyup="filterList()">
    <div id="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
    <ul id="person-list"></ul>
  </div>

  <div id="view-timer" class="view-content">
    <button class="timer-add-btn" onclick="openTimerModal()">ï¼‹ æ–°ã—ã„è¨˜éŒ²ã‚’è¿½åŠ </button>
    <div id="timer-loading" style="text-align:center; color:#999; display:none;">èª­ã¿è¾¼ã¿ä¸­...</div>
    <ul id="timer-list"></ul>
  </div>

  <div id="view-dojo" class="view-content">
    <div class="dojo-card">
      <div class="dojo-title">ğŸ² è©±é¡Œã‚¬ãƒãƒ£</div>
      <div class="gacha-btns">
        <div class="gacha-btn" onclick="drawTopic('é›‘è«‡')">â˜• é›‘è«‡</div>
        <div class="gacha-btn" onclick="drawTopic('ä»•äº‹')">ğŸ’¼ ä»•äº‹</div>
        <div class="gacha-btn" onclick="drawTopic('æ„›åª›')">ğŸŠ æ„›åª›</div>
        <div class="gacha-btn" onclick="drawTopic('æ‹æ„›')">ğŸ’• æ‹æ„›</div>
        <div class="gacha-btn" onclick="drawTopic('å­£ç¯€')">â˜€ å­£ç¯€</div>
      </div>
      <div id="gacha-result" class="gacha-result">
        <div id="gr-topic" class="gr-topic"></div>
        <div id="gr-detail" class="gr-detail"></div>
        <div id="gr-tip" class="gr-tip"></div>
      </div>
    </div>
    <div class="dojo-card">
      <div class="dojo-title">ğŸ¥Š ä¼šè©±ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</div>
      <select id="sim-role" style="width:100%; padding:8px; margin-bottom:10px; border-radius:5px; border:1px solid #ddd;">
        <option value="åŒåƒš">ç›¸æ‰‹ï¼šè·å ´ã®åŒåƒš</option>
        <option value="ä¸Šå¸">ç›¸æ‰‹ï¼šä¸Šå¸</option>
        <option value="å½¼å¥³">ç›¸æ‰‹ï¼šå½¼å¥³</option>
        <option value="åˆå¯¾é¢">ç›¸æ‰‹ï¼šåˆå¯¾é¢ã®äºº</option>
      </select>
      <div class="chat-box" id="sim-chat"><div class="chat-msg msg-ai">ã“ã‚“ã«ã¡ã¯ã€‚ç·´ç¿’ã—ã¾ã—ã‚‡ã†ï¼</div></div>
      <div class="sim-input-area">
        <input type="text" id="sim-input" class="sim-input" placeholder="ä¼šè©±ã‚’å…¥åŠ›...">
        <button class="sim-btn" onclick="sendSim()">é€ä¿¡</button>
      </div>
    </div>
  </div>

  <div id="modal" onclick="if(event.target === this) closeModal()">
    <div class="modal-content">
      <div class="modal-header">
        <div><span id="modal-name" class="m-name"></span><span id="modal-pin" onclick="togglePin()">â˜…</span><div id="modal-detail" style="font-size:12px; color:#666;"></div></div>
      </div>
      <div class="tab-group">
        <div class="tab-btn active" onclick="switchTab('memo')">ğŸ“ ãƒ¡ãƒ¢ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆ</div>
        <div class="tab-btn" onclick="switchTab('gift')">ğŸ è´ˆç­”ãƒªã‚¹ãƒˆ</div>
      </div>
      <div id="tab-memo" class="tab-content active">
        <div class="memo-area-wrapper"><textarea id="memo-text" placeholder="ãƒ¡ãƒ¢..."></textarea><button class="mic-btn" onclick="startVoiceInput()">ğŸ¤</button></div>
        <div class="event-section">
          <div class="input-row"><input type="date" id="event-date" class="input-date"><input type="text" id="event-name" class="input-text" placeholder="ã‚¤ãƒ™ãƒ³ãƒˆå"></div>
          <div class="input-row" style="margin-top:5px;"><input type="text" id="tags" class="input-text" style="flex:1;" placeholder="ã‚¿ã‚°"></div>
          
          <div class="tag-buttons">
            <button class="tag-btn" onclick="addTag('ã‚´ãƒ«ãƒ•')">ã‚´ãƒ«ãƒ•</button>
            <button class="tag-btn" onclick="addTag('æ—¥æœ¬é…’')">æ—¥æœ¬é…’</button>
            <button class="tag-btn" onclick="addTag('è»Š')">ğŸš™ è»Š</button>
            <button class="tag-btn" onclick="addTag('ãƒãƒ©ã‚½ãƒ³')">ğŸƒ ãƒãƒ©ã‚½ãƒ³</button>
            <button class="tag-btn" onclick="addTag('å®¶æ—')">å®¶æ—</button>
            <button class="tag-btn" onclick="addTag('ä»•äº‹')">ä»•äº‹</button>
          </div>

        </div>
        <div style="font-size:12px; font-weight:bold; color:#555; margin-bottom:5px;">â–¼ éå»ã®ãƒ¡ãƒ¢ï¼†AIææ¡ˆ</div>
        <div id="history-area">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
      <div id="tab-gift" class="tab-content">
        <div class="gift-form"><div class="input-row"><select id="gift-type" class="gift-type-select"><option value="receive">ã‚‚ã‚‰ã£ãŸ</option><option value="give">ã‚ã’ãŸ</option></select><input type="text" id="gift-item" class="input-text" placeholder="å“å"><button class="gift-add-btn" onclick="addGift()">è¿½åŠ </button></div></div>
        <ul id="gift-list"></ul>
      </div>
      <div class="btn-group"><button class="btn-cancel" onclick="closeModal()">é–‰ã˜ã‚‹</button><button class="btn-submit" onclick="submitMemo()">ä¿å­˜</button></div>
    </div>
  </div>

  <div id="timer-modal" onclick="if(event.target === this) closeTimerModal()" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:flex-end; justify-content:center; z-index:1100;">
    <div class="modal-content">
      <div class="modal-header"><div class="m-name" id="timer-modal-title">æ–°ã—ã„è¨˜éŒ²</div></div>
      <div class="input-row"><input type="text" id="timer-name" class="input-text" placeholder="ã‚¤ãƒ™ãƒ³ãƒˆå"></div>
      <div class="input-row"><input type="date" id="timer-date" class="input-date"></div>
      <div class="memo-area-wrapper"><textarea id="timer-memo" placeholder="ãƒ¡ãƒ¢"></textarea></div>
      <div id="timer-history-container" style="display:none; margin-top:15px;"><div style="font-size:12px; font-weight:bold; color:#555; margin-bottom:5px;">â–¼ éå»ã®å±¥æ­´</div><div id="timer-history-list" style="max-height:150px; overflow-y:auto; border:1px solid #eee; padding:5px; border-radius:5px;"></div></div>
      <div class="btn-group"><button class="btn-cancel" onclick="closeTimerModal()">é–‰ã˜ã‚‹</button><button class="btn-submit" onclick="saveTimer()">ä¿å­˜</button></div>
    </div>
  </div>

  <script>
    // â˜…æ–°ã—ã„GASã®URLã«å·®ã—æ›¿ãˆã¦ãã ã•ã„ï¼ˆã€Œãƒ‡ãƒ—ãƒ­ã‚¤ã€>ã€Œæ–°ã—ã„ãƒ‡ãƒ—ãƒ­ã‚¤ã€ã§ç™ºè¡Œã•ã‚ŒãŸã‚‚ã®ï¼‰
    const API_URL = "https://script.google.com/macros/s/AKfycbytL_5F_jBbJQ4XTUoE8xZXVBP4Fj68jugcMb1YEQrTnEtM1iSa9oQmYACymO1oFcYXLw/exec";

    /* é›»è»Šãƒ»å…±é€šå¤‰æ•° */
    const TIMETABLE = { toWork: { startHour: 6, endHour: 23, minutes: [6, 21, 36, 51] }, toHome: { startHour: 6, endHour: 23, minutes: [7, 22, 37, 52] } };
    let timerInterval = null;
    let allPeople = []; let selectedPerson = null; let isPinnedCurrent = false; let currentGiftList = [];
    let allTimers = [];

    document.addEventListener("DOMContentLoaded", () => {
      const savedRoute = localStorage.getItem("trainRoute");
      if (savedRoute) document.getElementById("route-select").value = savedRoute;
      updateTrainTimer();
      timerInterval = setInterval(updateTrainTimer, 1000);
    });

    window.onload = async function() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        renderList(data);
      } catch (e) { document.getElementById('loading').innerText = "Load Error"; }
    };

    function switchMainTab(viewId) {
      document.querySelectorAll('.view-content').forEach(el => el.classList.remove('active'));
      document.getElementById('view-' + viewId).classList.add('active');
      const btns = document.querySelectorAll('.main-tab-btn');
      btns.forEach(b => b.classList.remove('active'));
      if(viewId === 'list') btns[0].classList.add('active');
      else if(viewId === 'timer') { btns[1].classList.add('active'); loadTimerData(); } 
      else btns[2].classList.add('active');
    }

    /* SinceTimerãƒ­ã‚¸ãƒƒã‚¯ */
    async function loadTimerData() {
      const loading = document.getElementById('timer-loading');
      if (allTimers.length === 0) loading.style.display = 'block';
      try {
        const res = await fetch(API_URL + "?action=getTimer");
        allTimers = await res.json();
        renderTimerList();
      } catch(e) { console.error(e); }
      loading.style.display = 'none';
    }

    function renderTimerList() {
      const list = document.getElementById('timer-list');
      list.innerHTML = "";
      const grouped = {};
      allTimers.forEach(t => { if (!grouped[t.name]) grouped[t.name] = []; grouped[t.name].push(t); });
      const now = new Date(); now.setHours(0,0,0,0);
      Object.keys(grouped).forEach(name => {
        const history = grouped[name]; const latest = history[0]; const latestDate = new Date(latest.date); latestDate.setHours(0,0,0,0);
        const diffTime = now - latestDate; const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        let daysHtml = "";
        if (diffDays > 0) daysHtml = `<span class="t-days t-past">${diffDays}</span> <span class="t-unit">æ—¥å‰</span>`;
        else if (diffDays < 0) daysHtml = `<span class="t-unit">ã‚ã¨</span> <span class="t-days t-future">${Math.abs(diffDays)}</span> <span class="t-unit">æ—¥</span>`;
        else daysHtml = `<span class="t-days t-future">ä»Šæ—¥</span>`;
        const li = document.createElement('li'); li.className = 'timer-card';
        li.innerHTML = `<div class="t-header"><span class="t-name">${latest.name}</span><span class="t-date">æœ€çµ‚: ${latest.date}</span></div><div class="t-body">${daysHtml}</div><div style="font-size:12px; color:#888; margin-top:5px;">${latest.memo || ""}</div>`;
        li.onclick = () => openTimerModal(name); list.appendChild(li);
      });
    }

    function openTimerModal(name = "") {
      const modal = document.getElementById('timer-modal'); const title = document.getElementById('timer-modal-title'); const nameInput = document.getElementById('timer-name'); const dateInput = document.getElementById('timer-date'); const memoInput = document.getElementById('timer-memo'); const historyBox = document.getElementById('timer-history-container'); const historyList = document.getElementById('timer-history-list');
      const now = new Date(); const yyyy = now.getFullYear(); const mm = ("0"+(now.getMonth()+1)).slice(-2); const dd = ("0"+now.getDate()).slice(-2);
      dateInput.value = `${yyyy}-${mm}-${dd}`; memoInput.value = "";
      if (name) {
        title.innerText = name + " ã®è¨˜éŒ²"; nameInput.value = name; historyBox.style.display = 'block'; historyList.innerHTML = "";
        const historyData = allTimers.filter(t => t.name === name);
        historyData.forEach(h => { const div = document.createElement('div'); div.style.borderBottom = "1px solid #eee"; div.style.padding = "5px 0"; div.style.fontSize = "13px"; div.innerHTML = `<span style="font-weight:bold;">${h.date}</span> <span style="color:#666;">${h.memo}</span>`; historyList.appendChild(div); });
      } else { title.innerText = "æ–°ã—ã„è¨˜éŒ²ã‚’è¿½åŠ "; nameInput.value = ""; historyBox.style.display = 'none'; }
      modal.style.display = 'flex';
    }

    function closeTimerModal() { document.getElementById('timer-modal').style.display = 'none'; }
    async function saveTimer() {
      const name = document.getElementById('timer-name').value; const date = document.getElementById('timer-date').value; const memo = document.getElementById('timer-memo').value;
      if (!name || !date) return alert("å¿…é ˆé …ç›®ã§ã™");
      const btn = document.querySelector('#timer-modal .btn-submit'); btn.innerText = "ä¿å­˜ä¸­..."; btn.disabled = true;
      try { const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "saveTimer", eventName: name, date: date, memo: memo }) }); const result = await res.json(); if (result.status === "success") { alert("è¨˜éŒ²ã—ã¾ã—ãŸï¼"); closeTimerModal(); loadTimerData(); } else { alert("å¤±æ•—"); } } catch(e) { alert("Error"); } finally { btn.innerText = "ä¿å­˜"; btn.disabled = false; }
    }

    /* ãã®ä»– (é›»è»Š, ãƒªã‚¹ãƒˆ) */
    function changeRoute() { localStorage.setItem("trainRoute", document.getElementById("route-select").value); updateTrainTimer(); }
    function updateTrainTimer() {
      const routeKey = document.getElementById("route-select").value; const schedule = TIMETABLE[routeKey];
      const now = new Date(); const currentHour = now.getHours(); const currentMin = now.getMinutes();
      let nextTrain = null;
      for (let h = currentHour; h <= schedule.endHour; h++) {
        if (h < schedule.startHour) continue;
        for (let m of schedule.minutes) {
          if (h > currentHour || (h === currentHour && m > currentMin)) { nextTrain = new Date(); nextTrain.setHours(h); nextTrain.setMinutes(m); nextTrain.setSeconds(0); break; }
        }
        if (nextTrain) break;
      }
      const disp = document.getElementById("countdown-text"); const sub = document.getElementById("next-time-text");
      if (!nextTrain) { disp.innerText = "é‹è»¢çµ‚äº†"; sub.innerText = "--:--"; return; }
      const diffMs = nextTrain - now; const diffMin = Math.floor(diffMs / 60000); const diffSec = Math.floor((diffMs % 60000) / 1000);
      if (diffMin <= 0 && diffSec <= 0) disp.innerText = "ã¾ã‚‚ãªãç™ºè»Š"; else disp.innerHTML = `<span style="font-size:48px;">${diffMin}</span>åˆ† <span style="font-size:24px;">${diffSec}</span>ç§’`;
      sub.innerText = `ç™ºè»Šæ™‚åˆ»: ${('0'+nextTrain.getHours()).slice(-2)}:${('0'+nextTrain.getMinutes()).slice(-2)}`;
    }
    
    function renderList(data) {
      allPeople = data; const list = document.getElementById('person-list'); list.innerHTML = ""; document.getElementById('loading').style.display = 'none';
      const now = new Date().getTime(); const DAY_MS = 24 * 60 * 60 * 1000;
      data.forEach(p => {
        const li = document.createElement('li'); li.className = 'person-card';
        if (p.lastUpdated > 0) { const diffDays = (now - p.lastUpdated) / DAY_MS; if (diffDays > 90) li.classList.add('status-danger'); else if (diffDays > 30) li.classList.add('status-warning'); }
        li.dataset.searchText = (p.name + p.kana + p.section + p.role + p.tags + p.personality).toLowerCase();
        const bell = p.eventDate ? "ğŸ””" : ""; const tagsHtml = p.tags ? `<div class="p-tags">${p.tags}</div>` : "";
        let personHtml = ""; if (p.personality) { p.personality.split(',').forEach(item => { personHtml += `<span class="p-personality">ğŸ§ ${item.trim()}</span>`; }); }
        const pinClass = p.isPinned ? "pin-icon active" : "pin-icon"; const pinHtml = `<div class="${pinClass}">â˜…</div>`;
        li.innerHTML = `<div class="p-info"><div class="p-name">${p.name} ${bell} <span class="p-kana">${p.kana}</span></div><div class="p-detail"><span class="p-role">${p.role}</span> | ${p.section}</div>${personHtml}${tagsHtml}</div>${pinHtml}<div class="icon-edit">âœ</div>`;
        li.onclick = () => openModal(p); list.appendChild(li);
      });
    }
    function filterList() { const term = document.getElementById('search-box').value.toLowerCase(); document.querySelectorAll('.person-card').forEach(item => { item.style.display = item.dataset.searchText.includes(term) ? 'flex' : 'none'; }); }
    function switchTab(tabName) { document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active')); document.getElementById('tab-' + tabName).classList.add('active'); const btns = document.querySelectorAll('#modal .tab-btn'); if(tabName === 'memo') btns[0].classList.add('active'); else btns[1].classList.add('active'); }
    function renderGiftList() { const ul = document.getElementById('gift-list'); ul.innerHTML = ""; if (currentGiftList.length === 0) { ul.innerHTML = '<li style="color:#999; padding:10px; text-align:center;">è¨˜éŒ²ãªã—</li>'; return; } currentGiftList.forEach(g => { const li = document.createElement('li'); li.className = 'gift-item'; const typeLabel = g.type === 'receive' ? '<span class="gift-receive">â†ã‚‚ã‚‰ã£ãŸ</span>' : '<span class="gift-give">â†’ã‚ã’ãŸ</span>'; li.innerHTML = `<span>${typeLabel} ${g.item}</span> <span style="color:#888;">${g.date}</span>`; ul.appendChild(li); }); }
    function addGift() { const type = document.getElementById('gift-type').value; const item = document.getElementById('gift-item').value; if (!item) return; const now = new Date(); const dateStr = `${now.getFullYear()}/${now.getMonth()+1}/${now.getDate()}`; currentGiftList.unshift({ type: type, item: item, date: dateStr }); document.getElementById('gift-item').value = ""; renderGiftList(); }
    async function openModal(person) {
      selectedPerson = person; isPinnedCurrent = person.isPinned;
      try { currentGiftList = JSON.parse(person.giftHistory || "[]"); } catch(e) { currentGiftList = []; }
      document.getElementById('modal-name').innerText = person.name; document.getElementById('modal-detail').innerText = `${person.section} / ${person.role}`; document.getElementById('memo-text').value = ""; document.getElementById('event-date').value = person.eventDate || ""; document.getElementById('event-name').value = person.eventName || ""; document.getElementById('tags').value = person.tags ? person.tags.replace(/#/g, '').replace(/ /g, ' ') : "";
      const pinBtn = document.getElementById('modal-pin'); if (isPinnedCurrent) pinBtn.classList.add('active'); else pinBtn.classList.remove('active');
      renderGiftList(); switchTab('memo'); document.getElementById('modal').style.display = 'flex';
      const historyArea = document.getElementById('history-area'); historyArea.innerHTML = '<div style="color:#999;">èª­ã¿è¾¼ã¿ä¸­...</div>';
      try { const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "getHistory", name: person.name }) }); const history = await res.json(); if (!history || history.length === 0) historyArea.innerHTML = '<div style="color:#ccc;">å±¥æ­´ãªã—</div>'; else { let html = ""; history.forEach(h => { let aiHtml = h.aiAdvice ? `<div class="ai-box"><div class="ai-title">ğŸ¤– AIææ¡ˆ</div>${h.aiAdvice.replace(/\n/g, '<br>')}</div>` : ""; html += `<div class="history-item"><div class="history-date">${h.date}</div><div class="history-text">${h.memo}</div>${aiHtml}</div>`; }); historyArea.innerHTML = html; } } catch (e) { historyArea.innerText = "Error"; }
    }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    function togglePin() { isPinnedCurrent = !isPinnedCurrent; const b = document.getElementById('modal-pin'); isPinnedCurrent ? b.classList.add('active') : b.classList.remove('active'); }
    function startVoiceInput() { const btn = document.querySelector('.mic-btn'); const ta = document.getElementById('memo-text'); if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) { alert("éå¯¾å¿œ"); return; } const R = window.SpeechRecognition || window.webkitSpeechRecognition; const r = new R(); r.lang = 'ja-JP'; r.onstart=()=>btn.classList.add('recording'); r.onend=()=>btn.classList.remove('recording'); r.onresult=(e)=>{ta.value+=(ta.value?"\n":"")+e.results[0][0].transcript;}; r.start(); }
    function addTag(t) { const el = document.getElementById('tags'); if(!el.value.includes(t)) el.value = el.value ? el.value+" "+t : t; }
    async function submitMemo() {
      const memo = document.getElementById('memo-text').value; const eventDate = document.getElementById('event-date').value; const eventName = document.getElementById('event-name').value;
      let rawTags = document.getElementById('tags').value; let tags = ""; if (rawTags) { tags = rawTags.replace(/ã€€/g, ' ').split(' ').filter(t => t.trim() !== "").map(t => t.startsWith('#') ? t : '#' + t).join(' '); }
      const giftJson = JSON.stringify(currentGiftList); const isGiftChanged = giftJson !== (selectedPerson.giftHistory || "[]");
      if (!memo && !eventDate && !tags && isPinnedCurrent === selectedPerson.isPinned && !isGiftChanged) return;
      const btn = document.querySelector('#modal .btn-submit'); btn.innerText = "ä¿å­˜ä¸­..."; btn.disabled = true;
      try { const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "save", name: selectedPerson.name, memo: memo, eventDate: eventDate, eventName: eventName, tags: tags, isPinned: isPinnedCurrent, giftHistory: giftJson }) }); const result = await res.json(); if (result.status === "success") { alert("ä¿å­˜ã—ã¾ã—ãŸï¼"); closeModal(); location.reload(); } else { alert("å¤±æ•—: " + result.message); } } catch (e) { alert("Error: " + e); } finally { btn.innerText = "ä¿å­˜"; btn.disabled = false; }
    }
    async function drawTopic(category) { const resBox = document.getElementById('gacha-result'); resBox.style.display = 'block'; resBox.innerHTML = '<div style="text-align:center;">AIæ€è€ƒä¸­...</div>'; try { const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "training", mode: "gacha", text: category }) }); const data = await res.json(); resBox.innerHTML = `<div class="gr-topic">ğŸ’¡ ${data.topic}</div><div class="gr-detail">ã€Œ${data.detail}ã€</div><div class="gr-tip">â˜ï¸ ã‚¢ãƒ‰ãƒã‚¤ã‚¹: ${data.tip}</div>`; } catch(e) { resBox.innerText = "ã‚¨ãƒ©ãƒ¼: AIè¨±å¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„"; } }
    async function sendSim() { const inputEl = document.getElementById('sim-input'); const text = inputEl.value; if(!text) return; const role = document.getElementById('sim-role').value; const chatBox = document.getElementById('sim-chat'); chatBox.innerHTML += `<div class="chat-msg msg-user">${text}</div>`; inputEl.value = ""; chatBox.scrollTop = chatBox.scrollHeight; const loadingId = "l-"+new Date().getTime(); chatBox.innerHTML += `<div id="${loadingId}" class="chat-msg msg-ai">...</div>`; try { const res = await fetch(API_URL, { method: "POST", body: JSON.stringify({ action: "training", mode: "sim", text: `ç›¸æ‰‹å½¹=${role}, ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™ºè¨€=${text}` }) }); const data = await res.json(); document.getElementById(loadingId).remove(); chatBox.innerHTML += `<div class="chat-msg msg-ai">${data.reply}<span class="msg-feedback">ğŸ“Š ${data.score}ç‚¹: ${data.advice}</span></div>`; chatBox.scrollTop = chatBox.scrollHeight; } catch(e) { document.getElementById(loadingId).innerText = "ã‚¨ãƒ©ãƒ¼"; } }
  </script>
</body>
</html>
