<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>„Éç„ÇøÂ∏≥ÔºÜÈõªËªä</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f2f2f2; margin: 0; padding: 10px; color: #333; }
    
    /* --- ‚òÖÈõªËªä„Ç¶„Ç£„Ç∏„Çß„ÉÉ„Éà„ÅÆ„Éá„Ç∂„Ç§„É≥ --- */
    .train-widget {
      background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 99%); /* ‰ºä‰∫àÈâÑ„Ç´„É©„ÉºÈ¢® */
      padding: 15px; border-radius: 12px; margin-bottom: 20px; color: white;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    .train-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .train-select {
      background: rgba(255,255,255,0.9); border: none; padding: 5px 10px;
      border-radius: 20px; font-weight: bold; color: #333; font-size: 14px;
    }
    .train-timer { text-align: center; }
    .countdown-big { font-size: 36px; font-weight: bold; line-height: 1.2; text-shadow: 1px 1px 2px rgba(0,0,0,0.2); }
    .next-time-sub { font-size: 14px; font-weight: bold; margin-top: 5px; }

    /* Êó¢Â≠òCSS */
    #search-box { width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid #ddd; box-sizing: border-box; margin-bottom: 15px; background: white; appearance: none; }
    #person-list { list-style: none; padding: 0; margin: 0; padding-bottom: 60px; }
    .person-card { background: white; border-radius: 10px; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.1); cursor: pointer; border-left: 5px solid transparent; position: relative; }
    .status-warning { border-left-color: #ffc107; background-color: #fffdf5; }
    .status-danger { border-left-color: #ff4d4d; background-color: #fff5f5; }
    .pin-icon { position: absolute; top: 10px; right: 40px; font-size: 18px; color: #ccc; z-index: 10; }
    .pin-icon.active { color: #f4b400; text-shadow: 0 0 2px orange; }
    .p-info { flex: 1; }
    .p-name { font-size: 17px; font-weight: bold; }
    .p-kana { font-size: 11px; color: #999; margin-left: 8px; }
    .p-detail { font-size: 12px; color: #666; margin-top: 2px; }
    .p-tags { font-size: 11px; color: #007bff; margin-top: 2px; }
    .p-role { color: #00b900; font-weight: bold; }
    .icon-edit { font-size: 18px; color: #ccc; }

    /* „É¢„Éº„ÉÄ„É´ */
    #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: flex-end; justify-content: center; z-index: 1000; }
    .modal-content { background: white; width: 100%; max-width: 600px; padding: 20px; border-radius: 16px 16px 0 0; box-sizing: border-box; display: flex; flex-direction: column; max-height: 95vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
    .m-name { font-size: 18px; font-weight: bold; }
    #modal-pin { font-size: 24px; color: #ddd; cursor: pointer; }
    #modal-pin.active { color: #f4b400; }

    .memo-area-wrapper { position: relative; margin-bottom: 15px; }
    textarea { width: 100%; height: 80px; padding: 10px; padding-right: 40px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; resize: none; background: #fafafa; box-sizing: border-box;}
    .mic-btn { position: absolute; right: 10px; bottom: 10px; width: 30px; height: 30px; border-radius: 50%; background: #eee; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; border: none; }
    .mic-btn.recording { background: #ff4d4d; color: white; animation: pulse 1s infinite; }
    
    .event-section { background: #f0f8ff; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #d0e0ff; }
    .input-row { display: flex; gap: 10px; margin-bottom: 5px;}
    .input-date { flex: 1; padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; }
    .input-text { flex: 2; padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 14px; }
    .tag-buttons { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
    .tag-btn { background: white; border: 1px solid #007bff; color: #007bff; padding: 4px 10px; border-radius: 20px; font-size: 12px; cursor: pointer; }

    #history-area { background: #f9f9f9; padding: 10px; border-radius: 8px; overflow-y: auto; font-size: 13px; margin-bottom: 15px; border: 1px solid #eee; min-height: 80px; max-height: 250px; }
    .ai-box { background: #fff5f5; border-left: 4px solid #ff6b6b; padding: 8px; border-radius: 4px; font-size: 12px; color: #555; margin-top: 5px; }
    .history-item { border-bottom: 1px solid #ddd; padding: 10px 0; }
    .history-date { color: #00b900; font-weight: bold; font-size: 11px; margin-bottom: 4px; }

    .btn-group { display: flex; gap: 10px; }
    button { padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; flex: 1; }
    .btn-cancel { background: #eee; color: #555; }
    .btn-submit { background: #00b900; color: white; }
    #loading { text-align: center; margin-top: 50px; color: #666; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
  </style>
</head>
<body>

  <div class="train-widget">
    <div class="train-header">
      <span style="font-weight:bold;">üöÉ Ê¨°„ÅÆÈõªËªä</span>
      <select id="route-select" class="train-select" onchange="changeRoute()">
        <option value="toWork">Ë°å„ÅçÔºöÂ±±Ë•ø ‚Üí Ë°£Â±±</option>
        <option value="toHome">Â∏∞„ÇäÔºöË°£Â±± ‚Üí Â±±Ë•ø</option>
      </select>
    </div>
    <div class="train-timer">
      <div id="countdown-text" class="countdown-big">-- ÂàÜ -- Áßí</div>
      <div id="next-time-text" class="next-time-sub">Áô∫ËªäÊôÇÂàª: --:--</div>
    </div>
  </div>

  <input type="text" id="search-box" placeholder="ÂêçÂâç„Éª„Çø„Ç∞(Ë∂£Âë≥)„ÅßÊ§úÁ¥¢..." onkeyup="filterList()">
  <div id="loading">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
  <ul id="person-list"></ul>

  <div id="modal" onclick="if(event.target === this) closeModal()">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <span id="modal-name" class="m-name"></span>
          <span id="modal-pin" onclick="togglePin()">‚òÖ</span>
          <div id="modal-detail" style="font-size:12px; color:#666;"></div>
        </div>
      </div>
      <div class="memo-area-wrapper">
        <textarea id="memo-text" placeholder="„É°„É¢„ÇíÂÖ•Âäõ... („Éû„Ç§„ÇØ„ÅßÈü≥Â£∞ÂÖ•ÂäõÂèØ)"></textarea>
        <button class="mic-btn" onclick="startVoiceInput()">üé§</button>
      </div>
      <div class="event-section">
        <div class="input-row">
          <input type="date" id="event-date" class="input-date">
          <input type="text" id="event-name" class="input-text" placeholder="„Ç§„Éô„É≥„ÉàÂêç">
        </div>
        <div class="input-row" style="margin-top:5px;">
          <input type="text" id="tags" class="input-text" style="flex:1;" placeholder="„Çø„Ç∞ („Ç¥„É´„Éï ÈÖí „Å™„Å©)">
        </div>
        <div class="tag-buttons">
          <button class="tag-btn" onclick="addTag('„Ç¥„É´„Éï')">„Ç¥„É´„Éï</button>
          <button class="tag-btn" onclick="addTag('Êó•Êú¨ÈÖí')">Êó•Êú¨ÈÖí</button>
          <button class="tag-btn" onclick="addTag('„Çµ„Ç¶„Éä')">„Çµ„Ç¶„Éä</button>
          <button class="tag-btn" onclick="addTag('ÂÆ∂Êóè')">ÂÆ∂Êóè</button>
          <button class="tag-btn" onclick="addTag('‰ªï‰∫ã')">‰ªï‰∫ã</button>
          <button class="tag-btn" onclick="addTag('ÂêåÂÉö')">ÂêåÂÉö</button>
        </div>
      </div>
      <div style="font-size:12px; font-weight:bold; color:#555; margin-bottom:5px;">‚ñº ÈÅéÂéª„ÅÆ„É°„É¢ÔºÜAIÊèêÊ°à</div>
      <div id="history-area">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
      <div class="btn-group">
        <button class="btn-cancel" onclick="closeModal()">Èñâ„Åò„Çã</button>
        <button class="btn-submit" onclick="submitMemo()">ÈÄÅ‰ø°</button>
      </div>
    </div>
  </div>

  <script>
    // ‚òÖ„ÅîËá™Ë∫´„ÅÆGAS URL
    const API_URL = "https://script.google.com/macros/s/AKfycbyDU51p06sfivYJ05DCj60CBoJi8J62kLuagR88fVXviopESvT3_uqERuNZyE3wohD1tA/exec";

    /* =========================================
       ‚òÖ‰ºä‰∫àÈâÑÈ´òÊµúÁ∑ö ÊôÇÂàªË°®„Éá„Éº„Çø
       ÂÆüÈöõ„ÅÆ„ÉÄ„Ç§„É§ÔºàÂπ≥Êó•Êó•‰∏≠Ôºâ„Å´Âü∫„Å•„ÅÑ„Å¶Ë®≠ÂÆö„Åó„Å¶„ÅÑ„Åæ„Åô
       ========================================= */
    const TIMETABLE = {
      // Ë°å„ÅçÔºöÂ±±Ë•øÁô∫ (ÊùæÂ±±Â∏ÇÈßÖË°å„Åç)
      // 9ÊôÇÔΩû20ÊôÇ„ÅØÊØéÊôÇ 06, 21, 36, 51 ÂàÜÁô∫
      toWork: {
        startHour: 6, endHour: 23,
        minutes: [6, 21, 36, 51] 
      },
      // Â∏∞„ÇäÔºöË°£Â±±Áô∫ (È´òÊµúË°å„Åç)
      // 9ÊôÇÔΩû20ÊôÇ„ÅØÊØéÊôÇ 07, 22, 37, 52 ÂàÜÁô∫
      toHome: {
        startHour: 6, endHour: 23,
        minutes: [7, 22, 37, 52]
      }
    };

    let timerInterval = null;

    document.addEventListener("DOMContentLoaded", () => {
      const savedRoute = localStorage.getItem("trainRoute");
      if (savedRoute) {
        document.getElementById("route-select").value = savedRoute;
      }
      updateTrainTimer();
      timerInterval = setInterval(updateTrainTimer, 1000);
    });

    function changeRoute() {
      const route = document.getElementById("route-select").value;
      localStorage.setItem("trainRoute", route);
      updateTrainTimer();
    }

    function updateTrainTimer() {
      const routeKey = document.getElementById("route-select").value;
      const schedule = TIMETABLE[routeKey];
      const now = new Date();
      const currentHour = now.getHours();
      const currentMin = now.getMinutes();
      const currentSec = now.getSeconds();

      let nextTrain = null;

      for (let h = currentHour; h <= schedule.endHour; h++) {
        if (h < schedule.startHour) continue;
        for (let m of schedule.minutes) {
          if (h > currentHour || (h === currentHour && m > currentMin)) {
            nextTrain = new Date();
            nextTrain.setHours(h);
            nextTrain.setMinutes(m);
            nextTrain.setSeconds(0);
            break;
          }
        }
        if (nextTrain) break;
      }

      const displayMain = document.getElementById("countdown-text");
      const displaySub = document.getElementById("next-time-text");

      if (!nextTrain) {
        displayMain.innerText = "ÈÅãËª¢ÁµÇ‰∫Ü";
        displaySub.innerText = "Êú¨Êó•„ÅÆÈõªËªä„ÅØÁµÇ‰∫Ü„Åó„Åæ„Åó„Åü";
        return;
      }

      const diffMs = nextTrain - now;
      const diffMin = Math.floor(diffMs / 60000);
      const diffSec = Math.floor((diffMs % 60000) / 1000);

      if (diffMin <= 0 && diffSec <= 0) {
          displayMain.innerText = "„Åæ„ÇÇ„Å™„ÅèÁô∫Ëªä";
      } else {
          displayMain.innerHTML = `<span style="font-size:48px;">${diffMin}</span>ÂàÜ <span style="font-size:24px;">${diffSec}</span>Áßí`;
      }
      
      const nextH = ('0' + nextTrain.getHours()).slice(-2);
      const nextM = ('0' + nextTrain.getMinutes()).slice(-2);
      displaySub.innerText = `Áô∫ËªäÊôÇÂàª: ${nextH}:${nextM}`;
    }

    /* ‰ª•‰∏ã„ÄÅ„É°„É¢„Ç¢„Éó„É™Ê©üËÉΩÔºàÂ§âÊõ¥„Å™„ÅóÔºâ */
    let allPeople = [];
    let selectedPerson = null;
    let isPinnedCurrent = false;

    window.onload = async function() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        renderList(data);
      } catch (e) { document.getElementById('loading').innerText = "Load Error"; }
    };

    function renderList(data) {
      allPeople = data;
      const list = document.getElementById('person-list');
      list.innerHTML = "";
      document.getElementById('loading').style.display = 'none';
      const now = new Date().getTime();
      const DAY_MS = 24 * 60 * 60 * 1000;

      data.forEach(p => {
        const li = document.createElement('li');
        li.className = 'person-card';
        if (p.lastUpdated > 0) {
          const diffDays = (now - p.lastUpdated) / DAY_MS;
          if (diffDays > 90) li.classList.add('status-danger');
          else if (diffDays > 30) li.classList.add('status-warning');
        }
        li.dataset.searchText = (p.name + p.kana + p.section + p.role + p.tags).toLowerCase();
        
        const bell = p.eventDate ? "üîî" : "";
        const tagsHtml = p.tags ? `<div class="p-tags">${p.tags}</div>` : "";
        const pinClass = p.isPinned ? "pin-icon active" : "pin-icon";
        const pinHtml = `<div class="${pinClass}">‚òÖ</div>`;

        li.innerHTML = `
          <div class="p-info">
            <div class="p-name">${p.name} ${bell} <span class="p-kana">${p.kana}</span></div>
            <div class="p-detail"><span class="p-role">${p.role}</span> | ${p.section}</div>
            ${tagsHtml}
          </div>
          ${pinHtml}
          <div class="icon-edit">‚úé</div>
        `;
        li.onclick = () => openModal(p);
        list.appendChild(li);
      });
    }

    function filterList() {
      const term = document.getElementById('search-box').value.toLowerCase();
      document.querySelectorAll('.person-card').forEach(item => {
        item.style.display = item.dataset.searchText.includes(term) ? 'flex' : 'none';
      });
    }

    function startVoiceInput() {
      const btn = document.querySelector('.mic-btn');
      const textarea = document.getElementById('memo-text');
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert("ÈùûÂØæÂøú„Éñ„É©„Ç¶„Ç∂„Åß„Åô"); return;
      }
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      recognition.lang = 'ja-JP';
      recognition.interimResults = false;
      recognition.onstart = () => btn.classList.add('recording');
      recognition.onend = () => btn.classList.remove('recording');
      recognition.onresult = (event) => {
        textarea.value += (textarea.value ? "\n" : "") + event.results[0][0].transcript;
      };
      recognition.start();
    }

    function addTag(tagName) {
      const tagInput = document.getElementById('tags');
      const currentVal = tagInput.value;
      if (!currentVal.includes(tagName)) {
        tagInput.value = currentVal ? (currentVal + " " + tagName) : tagName;
      }
    }

    function togglePin() {
      isPinnedCurrent = !isPinnedCurrent;
      const pinBtn = document.getElementById('modal-pin');
      if (isPinnedCurrent) pinBtn.classList.add('active');
      else pinBtn.classList.remove('active');
    }

    async function openModal(person) {
      selectedPerson = person;
      isPinnedCurrent = person.isPinned;
      document.getElementById('modal-name').innerText = person.name;
      document.getElementById('modal-detail').innerText = `${person.section} / ${person.role}`;
      document.getElementById('memo-text').value = "";
      document.getElementById('event-date').value = person.eventDate || "";
      document.getElementById('event-name').value = person.eventName || "";
      document.getElementById('tags').value = person.tags ? person.tags.replace(/#/g, '').replace(/ /g, ' ') : "";
      
      const pinBtn = document.getElementById('modal-pin');
      if (isPinnedCurrent) pinBtn.classList.add('active');
      else pinBtn.classList.remove('active');

      document.getElementById('modal').style.display = 'flex';
      
      const historyArea = document.getElementById('history-area');
      historyArea.innerHTML = '<div style="color:#999;">Ë™≠„ÅøËæº„Åø‰∏≠...</div>';
      
      try {
        const res = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify({ action: "getHistory", name: person.name })
        });
        const history = await res.json();
        
        if (!history || history.length === 0) {
          historyArea.innerHTML = '<div style="color:#ccc;">Â±•Ê≠¥„Å™„Åó</div>';
        } else {
          let html = "";
          history.forEach(h => {
            let aiHtml = h.aiAdvice ? `<div class="ai-box"><div class="ai-title">ü§ñ AIÊèêÊ°à</div>${h.aiAdvice.replace(/\n/g, '<br>')}</div>` : "";
            html += `<div class="history-item"><div class="history-date">${h.date}</div><div class="history-text">${h.memo}</div>${aiHtml}</div>`;
          });
          historyArea.innerHTML = html;
        }
      } catch (e) { historyArea.innerText = "Error"; }
    }

    function closeModal() { document.getElementById('modal').style.display = 'none'; }

    async function submitMemo() {
      const memo = document.getElementById('memo-text').value;
      const eventDate = document.getElementById('event-date').value;
      const eventName = document.getElementById('event-name').value;
      
      let rawTags = document.getElementById('tags').value;
      let tags = "";
      if (rawTags) {
        tags = rawTags.replace(/„ÄÄ/g, ' ').split(' ')
          .filter(t => t.trim() !== "")
          .map(t => t.startsWith('#') ? t : '#' + t)
          .join(' ');
      }

      if (!memo && !eventDate && !tags && isPinnedCurrent === selectedPerson.isPinned) return;

      const btn = document.querySelector('.btn-submit');
      btn.innerText = "AIÊÄùËÄÉ‰∏≠...";
      btn.disabled = true;

      try {
        const res = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify({ 
            action: "save", 
            name: selectedPerson.name, 
            memo: memo,
            eventDate: eventDate,
            eventName: eventName,
            tags: tags,
            isPinned: isPinnedCurrent
          })
        });
        const result = await res.json();
        if (result.status === "success") {
          alert("‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ");
          closeModal();
          location.reload(); 
        } else {
          alert("Â§±Êïó: " + result.message);
        }
      } catch (e) { alert("Error: " + e); } 
      finally {
        btn.innerText = "ÈÄÅ‰ø°";
        btn.disabled = false;
      }
    }
  </script>
</body>
</html>
